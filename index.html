<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FocusLab | Identity Integrity System</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & Babel -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Markdown & LaTeX Engines -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/contrib/auto-render.min.js"></script>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, query } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";

        window.FirebaseSDK = { 
            initializeApp, getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken, 
            GoogleAuthProvider, signInWithPopup, signOut, getFirestore, doc, setDoc, 
            onSnapshot, collection, query 
        };
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #F9FAFB; overflow-x: hidden; }
        .custom-scrollbar::-webkit-scrollbar { height: 4px; width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .sticky-col { position: sticky; left: 0; z-index: 40; background: white; box-shadow: 4px 0 10px -2px rgba(0,0,0,0.05); }
        .integrity-gradient { background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); }
        .check-anim { transition: all 0.2s cubic-bezier(0.34, 1.56, 0.64, 1); }
        .check-anim:active { scale: 0.9; }
        .animate-fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .markdown-body h1, .markdown-body h2 { font-weight: 800; margin-top: 1em; margin-bottom: 0.5em; }
        .markdown-body p { margin-bottom: 0.8em; }
        .markdown-body ul { list-style-type: disc; padding-left: 1.5em; margin-bottom: 1em; }
        .markdown-body code { background: rgba(0,0,0,0.05); padding: 0.2em 0.4em; border-radius: 4px; font-family: monospace; }
        .katex-display { margin: 1em 0; overflow-x: auto; overflow-y: hidden; }
        .clock-pulse { animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    </style>
</head>
<body class="text-slate-900">
    <div id="root"></div>

    <script type="text/babel">
        // --- CONSTANTS ---
        const DEFAULT_HABITS = [
            { id: '1', name: 'Deep Work', icon: 'üíª', category: 'Morning', priority: 'core', limit: 11 },
            { id: '2', name: 'Movement', icon: 'üèÉ', category: 'Afternoon', priority: 'core', limit: 18 },
            { id: '3', name: 'Hydration', icon: 'üíß', category: 'Morning', priority: 'support', limit: 11 },
            { id: '4', name: 'Reading', icon: 'üìñ', category: 'Evening', priority: 'support', limit: 24 }
        ];

        const DEFAULT_PERSONA = "You are a Mindful Productivity Adviser for FocusLab. Focus on keeping words consistent with actions. Correlate user journal entries with their behavioral completion data to find blockers. Use Markdown and LaTeX ($...$).";
        const STORAGE_KEY = 'focuslab_behavioral_v3.5_journal_access';
        const MONTHS = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];

        // --- COMPONENTS ---
        const AiMessage = ({ text, role }) => {
            const containerRef = React.useRef(null);
            React.useLayoutEffect(() => {
                if (containerRef.current) {
                    renderMathInElement(containerRef.current, {
                        delimiters: [
                            {left: '$$', right: '$$', display: true},
                            {left: '$', right: '$', display: false}
                        ],
                        throwOnError: false
                    });
                }
            }, [text]);
            const htmlContent = React.useMemo(() => text ? marked.parse(text) : "", [text]);
            return (
                <div className={`flex ${role === 'user' ? 'justify-end' : 'justify-start'} animate-fade-in`}>
                    <div ref={containerRef} className={`max-w-[90%] p-4 rounded-3xl text-sm leading-relaxed markdown-body ${role === 'user' ? 'bg-indigo-600 text-white' : 'bg-white border border-slate-200 text-slate-800 shadow-sm'}`} dangerouslySetInnerHTML={{ __html: htmlContent }} />
                </div>
            );
        };

        const App = () => {
            const { useState, useEffect, useMemo, useRef } = React;

            // --- STATE ---
            const [user, setUser] = useState(null);
            const [habits, setHabits] = useState(DEFAULT_HABITS);
            const [completions, setCompletions] = useState({});
            const [activityLogs, setActivityLogs] = useState([]);
            const [journalEntries, setJournalEntries] = useState([]);
            const [conversations, setConversations] = useState([]);
            const [activeChatId, setActiveChatId] = useState(null);
            const [viewDate, setViewDate] = useState(new Date()); 
            const [isAdding, setIsAdding] = useState(false);
            const [isInfoOpen, setIsInfoOpen] = useState(false);
            const [isLogOpen, setIsLogOpen] = useState(false);
            const [logTab, setLogTab] = useState('integrity');
            const [isAiOpen, setIsAiOpen] = useState(false);
            const [isJournalOpen, setIsJournalOpen] = useState(false);
            const [journalInput, setJournalInput] = useState("");
            const [aiInput, setAiInput] = useState("");
            const [isAiLoading, setIsAiLoading] = useState(false);
            const [systemState, setSystemState] = useState({ 
                gmtOffset: 6, geminiKey: '', geminiPersona: DEFAULT_PERSONA, lastCommit: '', commitTime: 0 
            });
            const [time, setTime] = useState(new Date());

            // --- FIREBASE SERVICES ---
            const services = useMemo(() => {
                if (!window.FirebaseSDK) return null;
                const { initializeApp, getAuth, getFirestore } = window.FirebaseSDK;
                const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
                if (!firebaseConfig) return null;
                
                try {
                    const app = initializeApp(firebaseConfig);
                    const auth = getAuth(app);
                    const db = getFirestore(app);
                    const appId = typeof __app_id !== 'undefined' ? __app_id : 'focuslab-integrity';
                    return { app, auth, db, appId };
                } catch (e) { return null; }
            }, []);

            // --- COMPUTED ---
            const adjustedTime = useMemo(() => {
                const utc = time.getTime() + (time.getTimezoneOffset() * 60000);
                return new Date(utc + (3600000 * systemState.gmtOffset));
            }, [time, systemState.gmtOffset]);

            const currentHour = adjustedTime.getUTCHours();
            const todayKey = `${adjustedTime.getUTCFullYear()}-${String(adjustedTime.getUTCMonth() + 1).padStart(2, '0')}-${String(adjustedTime.getUTCDate()).padStart(2, '0')}`;
            const activeChat = useMemo(() => conversations.find(c => c.id === activeChatId), [conversations, activeChatId]);

            // --- PERSISTENCE ---
            const save = async (h, c, s, logs, journal, chats) => {
                const payload = { habits: h, completions: c, systemState: s, activityLogs: logs, journalEntries: journal, conversations: chats };
                localStorage.setItem(STORAGE_KEY, JSON.stringify(payload));
                
                if (user && !user.isAnonymous && services) {
                    try {
                        const { doc, setDoc } = window.FirebaseSDK;
                        await setDoc(doc(services.db, 'artifacts', services.appId, 'users', user.uid, 'data', 'behavioral_v3'), payload, { merge: true });
                    } catch (e) { console.error(e); }
                }
            };

            const logActivity = (action, details) => {
                const newLog = { timestamp: new Date().toISOString(), action, details, humanReadable: `${action.toUpperCase()}: ${details}` };
                const updated = [newLog, ...activityLogs].slice(0, 50);
                setActivityLogs(updated);
                return updated;
            };

            // --- AI LOGIC ---
            const callGemini = async (prompt, currentMessages) => {
                const apiKey = systemState.geminiKey;
                if (!apiKey) return;
                setIsAiLoading(true);
                
                // Enhanced Context: Including Journals
                const recentJournals = journalEntries.slice(0, 5).map(j => `[${new Date(j.timestamp).toLocaleDateString()}]: ${j.text}`).join('\n');
                
                const systemPrompt = `${systemState.geminiPersona}
                
                CURRENT CONTEXT:
                - Timezone: GMT+${systemState.gmtOffset}
                - Rituals Defined: ${JSON.stringify(habits)}
                - Points: ${integrityMetrics.pts}
                - User Identity Title: ${integrityMetrics.title}
                
                RECENT JOURNAL ENTRIES (USER REFLECTIONS):
                ${recentJournals || "No journal entries recorded yet."}
                
                Analyze the patterns between their ritual adherence and their journal entries.`;
                
                try {
                    const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({
                            contents: currentMessages.map(m => ({
                                role: m.role === 'assistant' ? 'model' : 'user',
                                parts: [{ text: m.text }]
                            })),
                            systemInstruction: { parts: [{ text: systemPrompt }] }
                        })
                    });
                    const data = await res.json();
                    const text = data.candidates?.[0]?.content?.parts?.[0]?.text || "Reflection failed.";
                    
                    const updatedChats = conversations.map(c => 
                        c.id === activeChatId ? { ...c, messages: [...c.messages, { role: 'assistant', text }], lastUpdated: new Date().toISOString() } : c
                    );
                    setConversations(updatedChats);
                    save(habits, completions, systemState, activityLogs, journalEntries, updatedChats);
                } catch (e) { console.error(e); } finally { setIsAiLoading(false); }
            };

            const handleAiSend = () => {
                if (!aiInput.trim() || isAiLoading || !activeChatId) return;
                const prompt = aiInput;
                setAiInput("");

                const updatedChats = conversations.map(c => 
                    c.id === activeChatId ? { 
                        ...c, 
                        messages: [...c.messages, { role: 'user', text: prompt }], 
                        lastUpdated: new Date().toISOString() 
                    } : c
                );
                setConversations(updatedChats);
                const currentSession = updatedChats.find(c => c.id === activeChatId);
                callGemini(prompt, currentSession.messages);
            };

            const createNewChat = () => {
                const newChat = {
                    id: Date.now().toString(),
                    title: `Session ${new Date().toLocaleDateString()} ${new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}`,
                    messages: [{ role: 'assistant', text: "Adviser present. I have analyzed your recent behavior and journal entries. How shall we proceed?" }],
                    lastUpdated: new Date().toISOString()
                };
                const updated = [newChat, ...conversations];
                setConversations(updated);
                setActiveChatId(newChat.id);
                save(habits, completions, systemState, activityLogs, journalEntries, updated);
            };

            const deleteChat = (id) => {
                const updated = conversations.filter(c => c.id !== id);
                setConversations(updated);
                if (activeChatId === id) setActiveChatId(updated[0]?.id || null);
                save(habits, completions, systemState, activityLogs, journalEntries, updated);
            };

            // --- INITIALIZATION ---
            useEffect(() => {
                const timer = setInterval(() => setTime(new Date()), 1000);
                const local = localStorage.getItem(STORAGE_KEY);
                if (local) {
                    const p = JSON.parse(local);
                    setHabits(p.habits || DEFAULT_HABITS);
                    setCompletions(p.completions || {});
                    setActivityLogs(p.activityLogs || []);
                    setJournalEntries(p.journalEntries || []);
                    setConversations(p.conversations || []);
                    if (p.systemState) setSystemState(p.systemState);
                    if (p.conversations?.length) setActiveChatId(p.conversations[0].id);
                }
                return () => clearInterval(timer);
            }, []);

            useEffect(() => {
                if (!services) return;
                const { signInAnonymously, onAuthStateChanged, signInWithCustomToken } = window.FirebaseSDK;
                const initAuth = async () => {
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await signInWithCustomToken(services.auth, __initial_auth_token);
                    } else {
                        await signInAnonymously(services.auth);
                    }
                };
                initAuth();
                const unsubscribe = onAuthStateChanged(services.auth, setUser);
                return () => unsubscribe();
            }, [services]);

            // --- INTEGRITY LOGIC ---
            const integrityMetrics = useMemo(() => {
                let pts = 0; let logs = [];
                Object.keys(completions).forEach(k => {
                    const c = completions[k]; const parts = k.split('-'); if (parts.length < 4) return;
                    const h = habits.find(h => h.id === parts[3]); if (!h) return;
                    if (!c.isLate) pts++; else pts -= 0.5;
                    logs.push({ type: c.isLate ? 'minus' : 'plus', points: c.isLate ? '-0.5' : '+1.0', reason: `${c.isLate ? 'Late' : 'Kept'}: ${h.name}`, date: `${parts[2]}/${parts[1]}`, time: new Date(c.timestamp).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) });
                });
                return { pts, title: pts > 50 ? "The Integrated" : pts > 10 ? "The Practitioner" : "The Observer", logs };
            }, [habits, completions]);

            const isCommitted = systemState.lastCommit === todayKey;

            return (
                <div className="pb-10 px-4 sm:px-10">
                    <div className="max-w-7xl mx-auto space-y-8 mt-10 animate-fade-in">
                        <header className="flex justify-between items-end">
                            <div className="space-y-1">
                                <span className="text-[10px] font-black uppercase text-slate-500 tracking-widest">FocusLab v3.5 ‚Ä¢ {integrityMetrics.title}</span>
                                <h1 className="text-5xl font-black tracking-tighter">Behavioral Analysis</h1>
                            </div>
                            <div className="bg-white p-2 rounded-full shadow-lg border flex items-center gap-3">
                                <div className="px-4 py-2 bg-slate-900 text-white rounded-full text-xs font-black flex items-center gap-2">
                                    <div className="w-2 h-2 bg-emerald-500 rounded-full clock-pulse" />
                                    {adjustedTime.toLocaleTimeString('en-US', {hour:'numeric', minute:'2-digit', hour12:true, timeZone:'UTC'})}
                                </div>
                                <button onClick={() => setIsInfoOpen(true)} className="w-10 h-10 rounded-full border flex items-center justify-center hover:bg-slate-50 transition-colors">‚öôÔ∏è</button>
                            </div>
                        </header>

                        <section className="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div className={`p-8 rounded-[3rem] shadow-xl ${isCommitted ? 'bg-white border' : 'integrity-gradient text-white'}`}>
                                <h3 className="text-[10px] font-black uppercase opacity-60 mb-4 tracking-widest">Commitment</h3>
                                {!isCommitted ? <button onClick={() => {
                                    const ns = {...systemState, lastCommit: todayKey, commitTime: Date.now()};
                                    setSystemState(ns); save(habits, completions, ns, logActivity('commit', todayKey), journalEntries, conversations);
                                }} className="w-full py-4 bg-indigo-500 text-white rounded-2xl font-black shadow-xl">Seal Today</button> : <p className="text-xl font-bold italic">Oath active. Grid unlocked.</p>}
                            </div>
                            <div className="bg-white p-8 rounded-[3rem] shadow-xl border flex flex-col justify-center items-center">
                                <div className="text-6xl font-black">{integrityMetrics.pts}</div>
                                <div className="text-[10px] font-black uppercase text-slate-400 mt-2 tracking-widest text-center">Integrity Score</div>
                            </div>
                            <div className="bg-indigo-600 p-8 rounded-[3rem] shadow-xl text-white flex flex-col justify-between">
                                <p className="text-sm font-medium opacity-80">AI Adviser now analyzing your Journal entries.</p>
                                <button onClick={() => { if(!conversations.length) createNewChat(); setIsAiOpen(true); }} className="w-full py-3 bg-white/20 rounded-xl font-black text-xs uppercase tracking-widest backdrop-blur-md">Enter Mindful Chat</button>
                            </div>
                        </section>

                        <div className={`bg-white rounded-[3rem] shadow-2xl border overflow-hidden relative ${!isCommitted ? 'opacity-20 blur-md pointer-events-none' : ''}`}>
                            <div className="overflow-x-auto custom-scrollbar">
                                <table className="w-full border-collapse">
                                    <thead className="bg-slate-50/50">
                                        <tr>
                                            <th className="sticky-col p-6 text-left border-b min-w-[200px]"><span className="text-[10px] font-black uppercase text-slate-400">Ritual Stack</span></th>
                                            {Array.from({length:31}, (_,i)=>i+1).map(d => <th key={d} className="p-4 border-b text-[10px] font-black text-slate-300">{d}</th>)}
                                        </tr>
                                    </thead>
                                    <tbody className="divide-y divide-slate-50">
                                        {habits.map(h => (
                                            <tr key={h.id} className="group hover:bg-slate-50/10 transition-colors">
                                                <td className="sticky-col p-6 font-bold text-sm">{h.icon} {h.name}</td>
                                                {Array.from({length:31}, (_,i)=>i+1).map(day => {
                                                    const key = `${viewDate.getFullYear()}-${String(viewDate.getMonth()+1).padStart(2,'0')}-${String(day).padStart(2,'0')}-${h.id}`;
                                                    const isDone = completions[key];
                                                    return <td key={day} className="p-2 text-center">
                                                        <button onClick={() => {
                                                            const isT = `${viewDate.getFullYear()}-${String(viewDate.getMonth()+1).padStart(2,'0')}-${String(day).padStart(2,'0')}` === todayKey;
                                                            const newC = {...completions}; if(newC[key]) delete newC[key]; else newC[key] = {timestamp: adjustedTime.toISOString(), isLate: !isT};
                                                            setCompletions(newC); save(habits, newC, systemState, logActivity('toggle', h.name), journalEntries, conversations);
                                                        }} className={`w-10 h-10 rounded-2xl flex items-center justify-center mx-auto transition-all ${isDone ? 'bg-indigo-600 text-white shadow-lg' : 'bg-slate-50 text-slate-200 hover:bg-slate-100'}`}>
                                                            {isDone ? '‚úì' : '‚Ä¢'}
                                                        </button>
                                                    </td>
                                                })}
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    {/* AI MODAL */}
                    {isAiOpen && (
                        <div className="fixed inset-0 z-[110] bg-slate-900/90 backdrop-blur-lg flex items-center justify-center p-4">
                            <div className="bg-white w-full max-w-5xl rounded-[3rem] shadow-2xl h-[85vh] flex overflow-hidden border">
                                <div className="w-72 bg-slate-50 border-r flex flex-col hidden md:flex">
                                    <div className="p-6 border-b">
                                        <button onClick={createNewChat} className="w-full py-3 bg-indigo-600 text-white rounded-xl font-black text-xs uppercase tracking-widest shadow-lg">New Session +</button>
                                    </div>
                                    <div className="flex-1 overflow-y-auto p-4 space-y-2 custom-scrollbar">
                                        {conversations.map(c => (
                                            <div key={c.id} className={`group relative p-4 rounded-2xl cursor-pointer transition-all ${activeChatId === c.id ? 'bg-white shadow-sm border border-indigo-100' : 'hover:bg-slate-100'}`} onClick={() => setActiveChatId(c.id)}>
                                                <div className="text-[10px] font-black text-slate-400 uppercase mb-1">Session</div>
                                                <div className="text-xs font-bold truncate pr-6">{c.title}</div>
                                                <button onClick={(e) => { e.stopPropagation(); deleteChat(c.id); }} className="absolute right-3 top-1/2 -translate-y-1/2 opacity-0 group-hover:opacity-100 text-slate-300 hover:text-red-500 transition-all">‚úï</button>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                                <div className="flex-1 flex flex-col bg-white">
                                    <div className="p-8 border-b flex justify-between items-center bg-indigo-600 text-white shrink-0">
                                        <div><h2 className="text-2xl font-black">Mindful Session</h2><p className="text-[10px] font-bold uppercase opacity-80">{activeChat?.title || "History Selection"}</p></div>
                                        <button onClick={() => setIsAiOpen(false)} className="bg-white/20 p-2 rounded-full hover:bg-white/30 transition-colors">‚úï</button>
                                    </div>
                                    <div className="flex-1 overflow-y-auto p-6 space-y-6 custom-scrollbar bg-slate-50/30">
                                        {activeChat?.messages.map((m, i) => <AiMessage key={i} text={m.text} role={m.role} />)}
                                        {isAiLoading && <div className="text-[10px] font-black text-indigo-400 animate-pulse px-4 uppercase tracking-widest text-center">Adviser is cross-referencing your journals...</div>}
                                    </div>
                                    <div className="p-6 border-t flex gap-3 bg-white shrink-0">
                                        <input value={aiInput} onChange={e => setAiInput(e.target.value)} onKeyPress={e => e.key === 'Enter' && handleAiSend()} className="flex-1 bg-slate-50 p-4 rounded-2xl text-sm outline-none border" placeholder="Ask the adviser to review your notes..." />
                                        <button onClick={handleAiSend} className="bg-indigo-600 text-white px-6 rounded-2xl font-black">‚Üí</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* SETTINGS */}
                    {isInfoOpen && (
                        <div className="fixed inset-0 z-[110] bg-slate-900/90 backdrop-blur-lg flex items-center justify-center p-6">
                            <div className="bg-white w-full max-w-xl rounded-[3rem] p-10 shadow-2xl space-y-6 animate-fade-in flex flex-col max-h-[90vh]">
                                <h2 className="text-3xl font-black shrink-0">Config</h2>
                                <div className="space-y-6 overflow-y-auto pr-2 custom-scrollbar">
                                    <div className="p-6 bg-slate-50 rounded-[2rem] space-y-4">
                                        <h4 className="text-[10px] font-black text-indigo-600 uppercase">Intelligence Setup</h4>
                                        <input type="password" value={systemState.geminiKey} onChange={e => { const ns = {...systemState, geminiKey: e.target.value}; setSystemState(ns); save(habits, completions, ns, activityLogs, journalEntries, conversations); }} placeholder="Gemini API Key" className="w-full p-3 bg-white border rounded-xl text-xs outline-none focus:ring-2 ring-indigo-50" />
                                        <textarea value={systemState.geminiPersona} onChange={e => { const ns = {...systemState, geminiPersona: e.target.value}; setSystemState(ns); save(habits, completions, ns, activityLogs, journalEntries, conversations); }} className="w-full p-3 h-24 bg-white border rounded-xl text-xs outline-none focus:ring-2 ring-indigo-50" />
                                    </div>
                                    <div className="p-6 bg-slate-50 rounded-[2rem]">
                                        <h4 className="text-[10px] font-black text-indigo-600 uppercase mb-4">GMT Calibration</h4>
                                        <select value={systemState.gmtOffset} onChange={e => { const ns = {...systemState, gmtOffset: parseInt(e.target.value)}; setSystemState(ns); save(habits, completions, ns, activityLogs, journalEntries, conversations); }} className="p-2 w-full rounded-xl font-bold bg-white border outline-none">
                                            {Array.from({length:27}, (_,i)=>i-12).map(o => <option key={o} value={o}>GMT {o>=0?'+':''}{o}</option>)}
                                        </select>
                                    </div>
                                </div>
                                <button onClick={() => setIsInfoOpen(false)} className="w-full py-5 bg-slate-900 text-white rounded-3xl font-black text-xs uppercase shrink-0">Close</button>
                            </div>
                        </div>
                    )}

                    {/* LEDGERS */}
                    {isLogOpen && (
                        <div className="fixed inset-0 z-[110] bg-slate-900/90 backdrop-blur-lg flex items-center justify-center p-6">
                            <div className="bg-white w-full max-w-2xl rounded-[3rem] p-10 shadow-2xl relative flex flex-col max-h-[85vh]">
                                <button onClick={() => setIsLogOpen(false)} className="absolute top-8 right-8 text-slate-400 font-black">‚úï</button>
                                <h2 className="text-3xl font-black tracking-tighter mb-4">Master Ledger</h2>
                                <div className="flex bg-slate-50 p-1 rounded-2xl mb-6 shrink-0">
                                    {['integrity', 'activity', 'journal'].map(t => <button key={t} onClick={() => setLogTab(t)} className={`flex-1 py-3 text-[10px] font-black uppercase tracking-widest rounded-xl transition-all ${logTab === t ? 'bg-white shadow-sm text-indigo-600' : 'text-slate-400'}`}>{t}</button>)}
                                </div>
                                <div className="flex-1 overflow-y-auto custom-scrollbar space-y-4 pr-2">
                                    {logTab === 'integrity' && integrityMetrics.logs.map((l, i) => <div key={i} className="p-4 bg-slate-50 rounded-2xl border flex justify-between items-center"><div className="space-y-1"><div className="text-[10px] font-black text-slate-400 uppercase">{l.date} ‚Ä¢ {l.time}</div><div className="text-sm font-bold text-slate-800">{l.reason}</div></div><div className={`text-sm font-black px-2 py-1 rounded-lg ${l.type==='plus'?'text-emerald-600 bg-emerald-50':'text-orange-600 bg-orange-50'}`}>{l.points}</div></div>)}
                                    {logTab === 'activity' && activityLogs.map((log, i) => <div key={i} className="p-4 bg-slate-50 rounded-2xl border text-sm font-bold text-slate-800 truncate">{log.humanReadable}</div>)}
                                    {logTab === 'journal' && journalEntries.map((e, i) => <div key={i} className="p-5 bg-slate-50 border rounded-3xl text-sm italic leading-relaxed text-slate-700">"{e.text}"</div>)}
                                </div>
                            </div>
                        </div>
                    )}

                    {/* JOURNALING MODAL */}
                    {isJournalOpen && (
                        <div className="fixed inset-0 z-[110] bg-slate-900/60 backdrop-blur-md flex items-center justify-center p-4">
                            <div className="bg-white w-full max-w-lg rounded-[3rem] p-10 shadow-2xl space-y-6 animate-fade-in border border-white">
                                <h2 className="text-2xl font-black tracking-tight">Personal Reflection</h2>
                                <p className="text-[10px] font-bold text-slate-400 uppercase">This note will be fed to the AI for behavioral analysis.</p>
                                <textarea value={journalInput} onChange={e => setJournalInput(e.target.value)} className="w-full h-40 p-6 bg-slate-50 rounded-3xl outline-none focus:ring-2 border text-sm leading-relaxed text-slate-700" placeholder="Why was focus difficult today?" />
                                <div className="flex gap-4">
                                    <button onClick={() => setIsJournalOpen(false)} className="flex-1 py-4 font-black text-slate-400">Discard</button>
                                    <button onClick={() => { 
                                        const updated = [{timestamp: new Date().toISOString(), text: journalInput}, ...journalEntries]; 
                                        setJournalEntries(updated); setJournalInput(""); setIsJournalOpen(false); 
                                        save(habits, completions, systemState, logActivity('journal', journalInput.substring(0,15)), updated, conversations); 
                                    }} className="flex-[2] bg-indigo-600 text-white py-4 rounded-3xl font-black shadow-xl hover:bg-indigo-700 transition-colors">Seal Note</button>
                                </div>
                            </div>
                        </div>
                    )}

                    <div className="fixed bottom-8 right-8 flex flex-col gap-4">
                        <button onClick={() => { if(!conversations.length) createNewChat(); setIsAiOpen(true); }} className="w-16 h-16 bg-indigo-600 text-white shadow-2xl rounded-full flex items-center justify-center text-xl hover:scale-110 active:scale-95 transition-all">üß†</button>
                        <button onClick={() => setIsJournalOpen(true)} className="w-16 h-16 bg-white border border-slate-100 shadow-2xl rounded-full flex items-center justify-center text-xl hover:scale-110 active:scale-95 transition-all">üìù</button>
                        <button onClick={() => setIsLogOpen(true)} className="w-16 h-16 bg-white border border-slate-100 shadow-2xl rounded-full flex items-center justify-center text-xl hover:scale-110 active:scale-95 transition-all">üìã</button>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
