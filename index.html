<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FocusLab | Identity Integrity System</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & Babel -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Markdown & LaTeX Engines -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/contrib/auto-render.min.js"></script>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, query } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";

        window.FirebaseSDK = { 
            initializeApp, getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken, 
            GoogleAuthProvider, signInWithPopup, signOut, getFirestore, doc, setDoc, 
            onSnapshot, collection, query 
        };
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&family=Kalam:wght@400;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #F8FAFC; overflow-x: hidden; }
        .custom-scrollbar::-webkit-scrollbar { height: 4px; width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .sticky-col { position: sticky; left: 0; z-index: 40; background: white; box-shadow: 4px 0 10px -2px rgba(0,0,0,0.05); }
        .integrity-gradient { background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); }
        .check-anim { transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); }
        .check-anim:active { transform: scale(0.85); }
        .urgent-pulse { animation: borderPulse 2s infinite; }
        @keyframes borderPulse { 0%, 100% { border-color: #ef4444; box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.2); } 50% { border-color: #fee2e2; box-shadow: 0 0 15px 5px rgba(239, 68, 68, 0.1); } }
        .markdown-body h1, .markdown-body h2 { font-weight: 800; margin-top: 1em; margin-bottom: 0.5em; color: #1e293b; }
        .markdown-body p { margin-bottom: 0.8em; }
        .markdown-body code { background: #f1f5f9; padding: 0.2em 0.4em; border-radius: 4px; font-family: monospace; font-size: 0.9em; }
        
        /* Dashboard Sticky Note UI */
        .dashboard-sticky {
            font-family: 'Kalam', cursive;
            background: linear-gradient(135deg, #fef3c7 0%, #fff9c4 100%);
            box-shadow: 4px 4px 12px rgba(0,0,0,0.08), inset 0 1px 1px rgba(255,255,255,0.6);
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            border-bottom-right-radius: 40px 5px;
            position: relative;
        }
        .dashboard-sticky-reminder {
            background: linear-gradient(135deg, #fce4ec 0%, #f8bbd0 100%);
        }
        .dashboard-sticky:hover {
            transform: scale(1.05) rotate(0deg) !important;
            box-shadow: 12px 12px 25px rgba(0,0,0,0.1);
            z-index: 20;
        }
        .sticky-pin {
            width: 12px; height: 12px;
            background: radial-gradient(circle at 30% 30%, #ff5f5f, #b91c1c);
            border-radius: 50%;
            position: absolute;
            top: -6px; left: 50%;
            transform: translateX(-50%);
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            z-index: 5;
        }

        .fab-menu-item { transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); opacity: 0; transform: translateY(20px) scale(0.5); }
        .fab-container:hover .fab-menu-item { opacity: 1; transform: translateY(0) scale(1); }
        .animate-fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .clock-pulse { animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    </style>
</head>
<body class="text-slate-900 selection:bg-indigo-100 selection:text-indigo-900">
    <div id="root"></div>

    <script type="text/babel">
        // --- ICONS ---
        const Icons = {
            Plus: ({size=24, className=""}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>,
            Cloud: ({size=24, className=""}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z"></path></svg>,
            Trash: ({size=24, className=""}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>,
            Brain: ({size=24, className=""}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M9.5 2A2.5 2.5 0 0 1 12 4.5v15a2.5 2.5 0 0 1-4.96.44 2.5 2.5 0 0 1-2.96-3.08 3 3 0 0 1-.34-5.58 2.5 2.5 0 0 1 1.32-4.24 2.5 2.5 0 0 1 1.98-3A2.5 2.5 0 0 1 9.5 2Z"></path><path d="M14.5 2A2.5 2.5 0 0 0 12 4.5v15a2.5 2.5 0 0 0 4.96.44 2.5 2.5 0 0 0 2.96-3.08 3 3 0 0 0 .34-5.58 2.5 2.5 0 0 0-1.32-4.24 2.5 2.5 0 0 0-1.98-3A2.5 2.5 0 0 0 14.5 2Z"></path></svg>,
            Edit: ({size=24, className=""}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>,
            Check: ({size=24, className=""}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="20 6 9 17 4 12"></polyline></svg>,
            Menu: ({size=24, className=""}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>,
            List: ({size=24, className=""}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="8" y1="6" x2="21" y2="6"></line><line x1="8" y1="12" x2="21" y2="12"></line><line x1="8" y1="18" x2="21" y2="18"></line><line x1="3" y1="6" x2="3.01" y2="6"></line><line x1="3" y1="12" x2="3.01" y2="12"></line><line x1="3" y1="18" x2="3.01" y2="18"></line></svg>
        };

        // --- CONSTANTS ---
        const DEFAULT_HABITS = [
            { id: '1', name: 'Deep Work', icon: 'üíª', start: 8, end: 11, category: 'Morning', prompt: 'What was your primary focus?' },
            { id: '2', name: 'Movement', icon: 'üèÉ', start: 16, end: 18, category: 'Afternoon', prompt: '' },
            { id: '3', name: 'Hydration', icon: 'üíß', start: 6, end: 11, category: 'Morning', prompt: '' },
            { id: '4', name: 'Reading', icon: 'üìñ', start: 20, end: 24, category: 'Evening', prompt: 'What insight did you gain?' }
        ];

        const DEFAULT_PERSONA = "You are the 'Mindful Architect,' a grounded mentor for FocusLab. Integrity is math: $I = \\frac{\\sum Actions}{\\sum Promises}$. Analyze behavioral logs, dashboard stickies, reminders, and habit-specific answers to find why I fail. Use Markdown and LaTeX.";
        const STORAGE_KEY = 'focuslab_v5.8_start_end_locks';
        const MONTHS = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];

        const AiMessage = React.memo(({ text, role }) => {
            const containerRef = React.useRef(null);
            React.useLayoutEffect(() => {
                if (containerRef.current) {
                    renderMathInElement(containerRef.current, { delimiters: [{left: '$$', right: '$$', display: true}, {left: '$', right: '$', display: false}], throwOnError: false });
                }
            }, [text]);
            const htmlContent = React.useMemo(() => text ? marked.parse(text) : "", [text]);
            return (
                <div className={`flex ${role === 'user' ? 'justify-end' : 'justify-start'} animate-fade-in mb-4`}>
                    <div ref={containerRef} className={`max-w-[90%] p-4 rounded-3xl text-sm leading-relaxed markdown-body ${role === 'user' ? 'bg-indigo-600 text-white shadow-xl' : 'bg-white border border-slate-100 text-slate-800 shadow-sm'}`} dangerouslySetInnerHTML={{ __html: htmlContent }} />
                </div>
            );
        });

        const HeaderClock = React.memo(({ gmtOffset }) => {
            const [date, setDate] = React.useState(new Date());
            React.useEffect(() => {
                const timer = setInterval(() => setDate(new Date()), 1000);
                return () => clearInterval(timer);
            }, []);
            const adjusted = new Date(date.getTime() + (date.getTimezoneOffset() * 60000) + (3600000 * gmtOffset));
            return (
                <span className="text-xs font-black text-slate-700 tracking-widest">
                    {adjusted.toLocaleTimeString('en-US', {hour:'numeric', minute:'2-digit', second: '2-digit', hour12:true})}
                </span>
            );
        });

        const App = () => {
            const { useState, useEffect, useMemo, useRef } = React;

            // --- STATE ---
            const [user, setUser] = useState(null);
            const [habits, setHabits] = useState(DEFAULT_HABITS);
            const [completions, setCompletions] = useState({});
            const [activityLogs, setActivityLogs] = useState([]);
            const [journalEntries, setJournalEntries] = useState([]); 
            const [reminders, setReminders] = useState([]); 
            const [todos, setTodos] = useState([]); 
            const [conversations, setConversations] = useState([]);
            const [quotes, setQuotes] = useState(["Your word is your bond.", "Behavior is the only truth."]);
            const [quickLinks, setQuickLinks] = useState([]);
            const [activeChatId, setActiveChatId] = useState(null);
            const [viewDate, setViewDate] = useState(new Date()); 
            
            // UI Modals & Menus
            const [isAdding, setIsAdding] = useState(false);
            const [editingHabitId, setEditingHabitId] = useState(null);
            const [isInfoOpen, setIsInfoOpen] = useState(false);
            const [isLogOpen, setIsLogOpen] = useState(false);
            const [logTab, setLogTab] = useState('journal');
            const [isAiOpen, setIsAiOpen] = useState(false);
            const [isJournalOpen, setIsJournalOpen] = useState(false);
            const [isSidebarOpen, setIsSidebarOpen] = useState(false); 
            const [isNavSidebarOpen, setIsNavSidebarOpen] = useState(false); 
            const [isLinkModalOpen, setIsLinkModalOpen] = useState(false);
            const [isTaskModalOpen, setIsTaskModalOpen] = useState(false); 
            
            // Note Capture Modal State
            const [noteType, setNoteType] = useState('reflection'); 
            
            // Prompt Feature State
            const [isPromptModalOpen, setIsPromptModalOpen] = useState(false);
            const [activePromptHabit, setActivePromptHabit] = useState(null);
            const [pendingCompletionKey, setPendingCompletionKey] = useState(null);
            const [promptInput, setPromptInput] = useState("");

            const [journalInput, setJournalInput] = useState("");
            const [aiInput, setAiInput] = useState("");
            const [isAiLoading, setIsAiLoading] = useState(false);
            const [systemState, setSystemState] = useState({ 
                gmtOffset: 6, geminiKey: '', geminiPersona: DEFAULT_PERSONA, lastCommit: '', commitTime: 0 
            });
            const [newHabit, setNewHabit] = useState({ name: '', icon: '‚ú®', start: 8, end: 11, category: 'Morning', prompt: '' });
            const [newQuoteInput, setNewQuoteInput] = useState("");
            const [newLink, setNewLink] = useState({ title: '', url: '', icon: 'üîó' });
            const [newTask, setNewTask] = useState(""); 
            const [time, setTime] = useState(new Date());

            const services = useMemo(() => {
                if (!window.FirebaseSDK) return null;
                const { initializeApp, getAuth, getFirestore } = window.FirebaseSDK;
                const config = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
                if (!config) return null;
                try {
                    const app = initializeApp(config);
                    return { auth: getAuth(app), db: getFirestore(app), appId: typeof __app_id !== 'undefined' ? __app_id : 'focuslab-v1' };
                } catch (e) { return null; }
            }, []);

            // --- ENGINE ---
            const adjustedTime = useMemo(() => {
                const utc = time.getTime() + (time.getTimezoneOffset() * 60000);
                return new Date(utc + (3600000 * systemState.gmtOffset));
            }, [time, systemState.gmtOffset]);

            const currentHour = adjustedTime.getUTCHours();
            const todayKey = `${adjustedTime.getUTCFullYear()}-${String(adjustedTime.getUTCMonth() + 1).padStart(2, '0')}-${String(adjustedTime.getUTCDate()).padStart(2, '0')}`;
            const isCommitted = useMemo(() => systemState.lastCommit === todayKey, [systemState.lastCommit, todayKey]);
            const activeChat = useMemo(() => conversations.find(c => c.id === activeChatId), [conversations, activeChatId]);

            const save = async (h, c, s, logs, journal, chats, q, r, links, tasks) => {
                const payload = { 
                    habits: h, completions: c, systemState: s, activityLogs: logs, 
                    journalEntries: journal, conversations: chats, quotes: q, reminders: r,
                    quickLinks: links, todos: tasks
                };
                localStorage.setItem(STORAGE_KEY, JSON.stringify(payload));
                if (user && !user.isAnonymous && services) {
                    try { 
                        const { doc, setDoc } = window.FirebaseSDK;
                        await setDoc(doc(services.db, 'artifacts', services.appId, 'users', user.uid, 'data', 'behavioral_v3'), payload, { merge: true }); 
                    } catch (e) {}
                }
            };

            const logActivity = (action, details) => {
                const newLog = { timestamp: new Date().toISOString(), action, details, humanReadable: `${action.toUpperCase()}: ${details}` };
                const updated = [newLog, ...activityLogs].slice(0, 50);
                setActivityLogs(updated);
                return updated;
            };

            // --- TASK LOGIC ---
            const addTask = () => {
                if (!newTask.trim()) return;
                const task = { id: Date.now().toString(), text: newTask, done: false, createdAt: new Date().toISOString() };
                const updated = [task, ...todos];
                setTodos(updated);
                setNewTask("");
                save(habits, completions, systemState, logActivity('add_task', 'Added to Protocol'), journalEntries, conversations, quotes, reminders, quickLinks, updated);
            };

            const toggleTask = (id) => {
                const updated = todos.map(t => t.id === id ? { ...t, done: !t.done } : t);
                setTodos(updated);
                const task = updated.find(t => t.id === id);
                save(habits, completions, systemState, logActivity(task.done ? 'complete_task' : 'reopen_task', task.text), journalEntries, conversations, quotes, reminders, quickLinks, updated);
            };

            const deleteTask = (id) => {
                const updated = todos.filter(t => t.id !== id);
                setTodos(updated);
                save(habits, completions, systemState, logActivity('delete_task', 'Removed'), journalEntries, conversations, quotes, reminders, quickLinks, updated);
            };

            // --- LINK MANAGEMENT ---
            const addQuickLink = () => {
                if (!newLink.title || !newLink.url) return;
                const updated = [...quickLinks, { ...newLink, id: Date.now().toString() }];
                setQuickLinks(updated);
                setNewLink({ title: '', url: '', icon: 'üîó' });
                setIsLinkModalOpen(false);
                save(habits, completions, systemState, activityLogs, journalEntries, conversations, quotes, reminders, updated, todos);
            };

            const deleteQuickLink = (id) => {
                if (!confirm("Remove this shortcut?")) return;
                const updated = quickLinks.filter(l => l.id !== id);
                setQuickLinks(updated);
                save(habits, completions, systemState, activityLogs, journalEntries, conversations, quotes, reminders, updated, todos);
            };

            // --- AI LOGIC ---
            const callGemini = async (prompt, currentMessages) => {
                const apiKey = ""; // Managed by environment
                setIsAiLoading(true);
                const recentJournals = journalEntries.slice(0, 5).map(j => j.text).join('\n');
                const activeRemindersText = reminders.map(r => r.text).join('\n');
                const ritualResponses = Object.keys(completions).filter(k => completions[k].answer).slice(-10).map(k => `[Habit Response]: ${completions[k].answer}`).join('\n');
                const taskStatus = `Pending: ${todos.filter(t => !t.done).length}, Completed: ${todos.filter(t => t.done).length}`;

                const systemPrompt = `${systemState.geminiPersona}\n\nUSER DATA:\nIntegrity: ${integrityMetrics.pts}pts\nTasks: ${taskStatus}\nJournal Notes:\n${recentJournals}\nReminders:\n${activeRemindersText}\nBehavioral Feedback:\n${ritualResponses}`;
                
                try {
                    const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({
                            contents: currentMessages.map(m => ({ role: m.role === 'assistant' ? 'model' : 'user', parts: [{ text: m.text }] })),
                            systemInstruction: { parts: [{ text: systemPrompt }] },
                            safetySettings: [
                                { category: "HARM_CATEGORY_HATE_SPEECH", threshold: "BLOCK_NONE" },
                                { category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_NONE" },
                                { category: "HARM_CATEGORY_SEXUALLY_EXPLICIT", threshold: "BLOCK_NONE" },
                                { category: "HARM_CATEGORY_DANGEROUS_CONTENT", threshold: "BLOCK_NONE" }
                            ]
                        })
                    });
                    const data = await res.json();
                    const text = data.candidates?.[0]?.content?.parts?.[0]?.text || "Architect silent.";
                    const updated = conversations.map(c => c.id === activeChatId ? { ...c, messages: [...c.messages, { role: 'assistant', text }], lastUpdated: new Date().toISOString() } : c);
                    setConversations(updated);
                    save(habits, completions, systemState, activityLogs, journalEntries, updated, quotes, reminders, quickLinks, todos);
                } catch (e) {} finally { setIsAiLoading(false); }
            };

            const handleAiSend = () => {
                if (!aiInput.trim() || isAiLoading || !activeChatId) return;
                const prompt = aiInput; setAiInput("");
                const updated = conversations.map(c => c.id === activeChatId ? { ...c, messages: [...c.messages, { role: 'user', text: prompt }], lastUpdated: new Date().toISOString() } : c);
                setConversations(updated);
                const currentSession = updated.find(c => c.id === activeChatId);
                callGemini(prompt, currentSession.messages);
            };

            const createNewChat = () => {
                const newChat = { id: Date.now().toString(), title: `Chat ${new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}`, messages: [{ role: 'assistant', text: "Adviser present. I've synced your latest notes and reminders. How shall we begin?" }], lastUpdated: new Date().toISOString() };
                const updated = [newChat, ...conversations]; setConversations(updated); setActiveChatId(newChat.id);
                save(habits, completions, systemState, activityLogs, journalEntries, updated, quotes, reminders, quickLinks, todos);
            };

            // --- HABIT ACTIONS (UPDATED FOR START/END LOCK) ---
            const toggleHabit = (day, habit) => {
                const key = `${viewDate.getFullYear()}-${String(viewDate.getMonth()+1).padStart(2,'0')}-${String(day).padStart(2,'0')}-${habit.id}`;
                const isT = day === adjustedTime.getUTCDate() && viewDate.getMonth() === adjustedTime.getUTCMonth();
                
                // --- LOCK LOGIC START ---
                // habit.start and habit.end are hours (0-24)
                const startHour = habit.start || 0; 
                const endHour = habit.end || 24;
                
                const newC = {...completions};

                if (newC[key]) {
                    // Turn Off
                    delete newC[key];
                    setCompletions(newC);
                    save(habits, newC, systemState, logActivity('untoggle', habit.name), journalEntries, conversations, quotes, reminders, quickLinks, todos);
                } else {
                    // Turn On
                    if (isT) {
                         if (currentHour < startHour) {
                             alert(`Ritual Locked. Window opens at ${format12h(startHour)}.`);
                             return;
                         }
                    }

                    const expired = isT && currentHour >= endHour;

                    if (expired && !confirm("Window Closed. Marking this as LATE (-0.5 pts)?")) return;
                    
                    if (habit.prompt) {
                        setActivePromptHabit(habit); setPendingCompletionKey(key); setIsPromptModalOpen(true); setPromptInput("");
                    } else {
                        newC[key] = { timestamp: adjustedTime.toISOString(), isLate: !isT || expired };
                        setCompletions(newC);
                        save(habits, newC, systemState, logActivity('toggle', habit.name), journalEntries, conversations, quotes, reminders, quickLinks, todos);
                    }
                }
            };

            const finalizePromptCompletion = () => {
                const habit = activePromptHabit; const key = pendingCompletionKey; if (!habit || !key) return;
                const dayParts = key.split('-');
                const isT = parseInt(dayParts[2]) === adjustedTime.getUTCDate() && (parseInt(dayParts[1]) - 1) === adjustedTime.getUTCMonth();
                const endHour = habit.end || 24;
                const expired = isT && currentHour >= endHour;
                const newC = { ...completions, [key]: { timestamp: adjustedTime.toISOString(), isLate: !isT || expired, answer: promptInput } };
                setCompletions(newC);
                save(habits, newC, systemState, logActivity('toggle', habit.name + ' (w/ answer)'), journalEntries, conversations, quotes, reminders, quickLinks, todos);
                setIsPromptModalOpen(false); setActivePromptHabit(null); setPendingCompletionKey(null);
            };

            const handleRitualSubmit = () => {
                if (!newHabit.name) return;
                let updated;
                // Ensure defaults if not set in UI (though UI forces them now)
                const finalHabit = {
                    ...newHabit,
                    start: parseInt(newHabit.start) || 0,
                    end: parseInt(newHabit.end) || 24
                };

                if (editingHabitId) {
                    updated = habits.map(h => h.id === editingHabitId ? { ...h, ...finalHabit } : h);
                    logActivity('edit_ritual', newHabit.name);
                } else {
                    updated = [...habits, { ...finalHabit, id: Date.now().toString() }];
                    logActivity('add_ritual', newHabit.name);
                }
                setHabits(updated);
                save(updated, completions, systemState, activityLogs, journalEntries, conversations, quotes, reminders, quickLinks, todos);
                setNewHabit({ name: '', icon: '‚ú®', category: 'Morning', prompt: '', start: 8, end: 11 }); 
                setEditingHabitId(null); 
                setIsAdding(false);
            };

            const deleteHabit = (id) => {
                if (!confirm("Permanently retire this ritual?")) return;
                const updated = habits.filter(h => h.id !== id);
                setHabits(updated);
                save(updated, completions, systemState, logActivity('delete_ritual', 'ID: '+id), journalEntries, conversations, quotes, reminders, quickLinks, todos);
            };

            const integrityMetrics = useMemo(() => {
                let pts = 0; let logs = [];
                Object.keys(completions).forEach(k => {
                    const c = completions[k]; const parts = k.split('-'); if (parts.length < 4) return;
                    const h = habits.find(h => h.id === parts[3]); if (!h) return;
                    if (!c.isLate) pts++; else pts -= 0.5;
                    logs.push({ type: c.isLate ? 'minus' : 'plus', points: c.isLate ? '-0.5' : '+1.0', reason: `${c.isLate ? 'Late' : 'Kept'}: ${h.name}`, date: `${parts[2]}/${parts[1]}`, time: new Date(c.timestamp).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}), answer: c.answer });
                });
                const tiers = [{t: "The Observer", m: 0}, {t: "The Practitioner", m: 10}, {t: "The Integrated", m: 50}, {t: "The Architect", m: 100}];
                const currentTier = tiers.filter(t => pts >= t.m).pop() || tiers[0];
                const nextTier = tiers[tiers.indexOf(currentTier) + 1] || currentTier;
                const progress = nextTier === currentTier ? 100 : ((pts - currentTier.m) / (nextTier.m - currentTier.m)) * 100;
                return { pts, title: currentTier.t, nextTier: nextTier.t, progress, logs };
            }, [habits, completions]);

            const format12h = (hour) => {
                if (hour === 24) return "12 AM (Night)";
                const h = hour % 12 || 12;
                const ampm = hour >= 12 && hour < 24 ? 'PM' : 'AM';
                return `${h} ${ampm}`;
            };
            
            const formatTimeRange = (start, end) => {
                return `${format12h(start)} - ${format12h(end)}`;
            };

            const getNextObjective = () => {
                // Find habits that are currently active (start <= now < end) and not done
                // Priority to CORE habits
                const activeHabits = habits.filter(h => {
                    const key = `${todayKey}-${h.id}`;
                    return !completions[key] && currentHour >= h.start && currentHour < h.end;
                });
                
                if (activeHabits.length === 0) return null;
                
                // Sort: Core first, then by earliest end time (urgency)
                activeHabits.sort((a, b) => {
                    if (a.priority === 'core' && b.priority !== 'core') return -1;
                    if (b.priority === 'core' && a.priority !== 'core') return 1;
                    return a.end - b.end;
                });
                
                return activeHabits[0];
            };
            
            const nextObjective = useMemo(getNextObjective, [habits, completions, currentHour, todayKey]);


            // --- INIT ---
            useEffect(() => {
                const timer = setInterval(() => setTime(new Date()), 60000);
                const local = localStorage.getItem(STORAGE_KEY);
                if (local) {
                    const p = JSON.parse(local);
                    // Migrate habits if they are old format (missing start/end)
                    const migratedHabits = (p.habits || DEFAULT_HABITS).map(h => ({
                        ...h,
                        start: h.start !== undefined ? h.start : 0, // Default start
                        end: h.end !== undefined ? h.end : (h.limit || 24) // Default end or map from old limit
                    }));
                    
                    setHabits(migratedHabits); 
                    setCompletions(p.completions || {});
                    setActivityLogs(p.activityLogs || []); setJournalEntries(p.journalEntries || []);
                    setConversations(p.conversations || []); if (p.systemState) setSystemState(p.systemState);
                    if (p.conversations?.length) setActiveChatId(p.conversations[0].id);
                    if (p.quotes) setQuotes(p.quotes);
                    if (p.reminders) setReminders(p.reminders);
                    if (p.quickLinks) setQuickLinks(p.quickLinks);
                    if (p.todos) setTodos(p.todos);
                }
                return () => clearInterval(timer);
            }, []);

            useEffect(() => {
                if (!services) return;
                const { signInAnonymously, onAuthStateChanged, signInWithCustomToken } = window.FirebaseSDK;
                const authInit = async () => {
                    try {
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) await signInWithCustomToken(services.auth, __initial_auth_token);
                        else await signInAnonymously(services.auth);
                    } catch (e) {}
                };
                authInit();
                return onAuthStateChanged(services.auth, setUser);
            }, [services]);

            return (
                <div className="pb-24 px-4 sm:px-10 max-w-7xl mx-auto space-y-10 mt-6 md:mt-10 animate-fade-in relative">
                    
                    {/* QUICK ACCESS SIDEBAR */}
                    <div className={`fixed top-0 left-0 h-full w-72 bg-white shadow-2xl z-[60] transform transition-transform duration-300 ${isNavSidebarOpen ? 'translate-x-0' : '-translate-x-full'}`}>
                        <div className="p-8 border-b flex justify-between items-center">
                            <h2 className="text-xl font-black text-slate-900 tracking-tight">Quick Access</h2>
                            <button onClick={() => setIsNavSidebarOpen(false)} className="text-slate-400 hover:text-slate-600 transition-colors">‚úï</button>
                        </div>
                        <div className="flex-1 overflow-y-auto p-6 space-y-4 custom-scrollbar">
                            <div 
                                onClick={() => { setIsTaskModalOpen(true); setIsNavSidebarOpen(false); }}
                                className="flex items-center justify-between p-4 rounded-2xl bg-indigo-50 border border-indigo-100 hover:bg-indigo-100 transition-all cursor-pointer group"
                            >
                                <div className="flex items-center gap-3">
                                    <span className="text-xl">‚öîÔ∏è</span>
                                    <span className="text-sm font-bold text-indigo-900">Task Protocol</span>
                                </div>
                                <span className="bg-indigo-200 text-indigo-700 text-[9px] font-black px-2 py-1 rounded-full">{todos.filter(t=>!t.done).length}</span>
                            </div>
                            
                            {quickLinks.map(link => (
                                <div key={link.id} className="flex items-center justify-between p-4 rounded-2xl bg-slate-50 hover:bg-slate-100 transition-all group">
                                    <a href={link.url} target="_blank" rel="noopener noreferrer" className="flex items-center gap-3 flex-1">
                                        <span className="text-xl">{link.icon}</span>
                                        <span className="text-sm font-bold text-slate-700">{link.title}</span>
                                    </a>
                                    <button onClick={() => deleteQuickLink(link.id)} className="text-slate-300 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-opacity"><Icons.Trash size={14} /></button>
                                </div>
                            ))}
                        </div>
                        <div className="p-6 border-t bg-slate-50/50">
                            <button onClick={() => setIsLinkModalOpen(true)} className="w-full py-4 bg-white border border-slate-200 text-indigo-600 rounded-2xl font-black text-xs uppercase tracking-widest shadow-sm hover:shadow-md transition-all flex items-center justify-center gap-2">
                                <Icons.Plus size={14} /> Add Tool
                            </button>
                        </div>
                    </div>
                    {isNavSidebarOpen && <div className="fixed inset-0 bg-slate-900/30 backdrop-blur-sm z-[50]" onClick={() => setIsNavSidebarOpen(false)} />}

                    {/* HEADER */}
                    <header className="flex flex-col md:flex-row justify-between items-start md:items-end gap-6 bg-white p-6 md:p-10 rounded-[3rem] shadow-sm border border-slate-100 relative z-40">
                        <div className="flex items-center gap-6 w-full md:w-auto">
                             <button onClick={() => setIsNavSidebarOpen(true)} className="w-12 h-12 rounded-2xl bg-white border border-slate-200 flex items-center justify-center hover:bg-slate-50 hover:border-indigo-200 transition-all shadow-sm">
                                <Icons.Menu size={24} className="text-slate-600" />
                            </button>
                            <div className="space-y-4">
                                <div className="space-y-1">
                                    <div className="flex items-center gap-3">
                                        <span className="h-2 w-2 bg-indigo-600 rounded-full animate-pulse" />
                                        <span className="text-[10px] font-black uppercase text-slate-400 tracking-[0.2em]">{integrityMetrics.title}</span>
                                    </div>
                                    <h1 className="text-4xl md:text-6xl font-black tracking-tighter text-slate-900 leading-none">Identity Evolution</h1>
                                </div>
                                <div className="w-full md:w-64">
                                    <div className="flex justify-between text-[8px] font-black uppercase text-slate-400 mb-1 tracking-widest">
                                        <span>Progress: {Math.round(integrityMetrics.progress)}%</span>
                                    </div>
                                    <div className="h-2 w-full bg-slate-100 rounded-full overflow-hidden">
                                        <div className="h-full bg-indigo-600 transition-all duration-1000 ease-out shadow-[0_0_10px_rgba(79,70,229,0.4)]" style={{ width: `${integrityMetrics.progress}%` }} />
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div className="flex items-center gap-3 bg-slate-50 p-2 rounded-full border border-slate-200/50">
                            <div className="px-6 py-3 bg-slate-900 text-white rounded-full text-xs font-black shadow-lg">
                                <HeaderClock gmtOffset={systemState.gmtOffset} />
                            </div>
                            <button onClick={() => setIsInfoOpen(true)} className="w-12 h-12 rounded-full bg-white shadow-sm border border-slate-200 flex items-center justify-center hover:bg-slate-100 transition-all text-xl">‚öôÔ∏è</button>
                        </div>
                    </header>

                    {/* STATS SECTION */}
                    <section className="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div className={`p-8 rounded-[3.5rem] shadow-xl transition-all duration-500 flex flex-col justify-between min-h-[220px] ${isCommitted ? 'bg-white border' : 'integrity-gradient text-white shadow-indigo-200/50'}`}>
                            <div><h3 className="text-[10px] font-black uppercase opacity-60 mb-2 tracking-widest">Daily Oath</h3>{!isCommitted ? <p className="text-lg font-bold leading-tight">Commit your word to unlock the grid.</p> : <p className="text-lg font-bold italic text-slate-800">Identity locked. Rituals active.</p>}</div>
                            {!isCommitted && <button onClick={() => { const ns = {...systemState, lastCommit: todayKey, commitTime: Date.now()}; setSystemState(ns); save(habits, completions, ns, logActivity('commit', todayKey), journalEntries, conversations, quotes, reminders, quickLinks, todos); }} className="w-full py-4 bg-indigo-500 text-white rounded-2xl font-black shadow-xl hover:scale-105 active:scale-95 transition-all">Seal Today</button>}
                        </div>
                        <div className="bg-white p-8 rounded-[3.5rem] shadow-xl border flex flex-col justify-center items-center group text-center"><div className="text-7xl font-black tracking-tighter group-hover:text-indigo-600 transition-colors">{integrityMetrics.pts}</div><div className="text-[10px] font-black uppercase text-slate-400 mt-2 tracking-[0.2em]">Honesty Quotient</div></div>
                        
                        {/* NEXT OBJECTIVE CARD (Smart Recommendation) */}
                        <div className="bg-white p-8 rounded-[3.5rem] shadow-xl border border-slate-100 flex flex-col justify-between group overflow-hidden relative">
                             <div>
                                <h3 className="text-[10px] font-black uppercase text-slate-400 mb-2 tracking-widest">Next Objective</h3>
                                {nextObjective ? (
                                    <div className="space-y-2">
                                        <div className="text-2xl font-black text-indigo-900 leading-tight">{nextObjective.icon} {nextObjective.name}</div>
                                        <div className="text-[10px] font-bold text-slate-500 uppercase tracking-widest bg-slate-50 px-2 py-1 rounded w-fit">
                                            Window: {formatTimeRange(nextObjective.start, nextObjective.end)}
                                        </div>
                                    </div>
                                ) : (
                                    <p className="text-lg font-bold text-slate-300 italic">No active rituals in current window.</p>
                                )}
                             </div>
                             <div className="absolute -bottom-4 -right-4 text-[8rem] opacity-5 select-none pointer-events-none">‚ö°</div>
                        </div>
                    </section>

                    {/* RITUAL GRID */}
                    <div className={`bg-white rounded-[4rem] shadow-2xl border border-slate-100 overflow-hidden transition-all duration-700 ${!isCommitted ? 'opacity-20 blur-md pointer-events-none' : ''}`}>
                        <div className="overflow-x-auto custom-scrollbar">
                            <table className="w-full border-collapse">
                                <thead className="bg-slate-50/50">
                                    <tr>
                                        <th className="sticky-col p-8 text-left border-b min-w-[280px]">
                                            <div className="flex items-center justify-between"><div className="flex flex-col gap-1"><span className="text-[11px] font-black uppercase text-slate-400 tracking-[0.2em]">Ritual Stack</span><span className="text-[9px] font-bold text-indigo-500 uppercase tracking-widest">Time-Lock Active</span></div><button onClick={() => { setEditingHabitId(null); setNewHabit({ name: '', icon: '‚ú®', category: 'Morning', prompt: '', start: 8, end: 11 }); setIsAdding(true); }} className="bg-indigo-600 hover:bg-indigo-700 text-white p-2 rounded-xl shadow-lg active:scale-90 transition-all"><Icons.Plus size={16} /></button></div>
                                        </th>
                                        {Array.from({length:31}, (_,i)=>i+1).map(d => { const isT = d === adjustedTime.getUTCDate() && viewDate.getMonth() === adjustedTime.getUTCMonth(); return <th key={d} className={`p-4 border-b text-[10px] font-black ${isT ? 'text-indigo-600 bg-indigo-50/50' : 'text-slate-300'}`}>{isT ? 'TODAY' : d}</th> })}
                                    </tr>
                                </thead>
                                <tbody className="divide-y divide-slate-50">
                                    {habits.map(h => {
                                        // "Urgent" if active and less than 2 hours remaining
                                        const isActive = currentHour >= h.start && currentHour < h.end;
                                        const remaining = h.end - currentHour;
                                        const isUrgent = isActive && remaining <= 2;
                                        
                                        return (
                                            <tr key={h.id} className="group hover:bg-slate-50/10 transition-colors">
                                                <td className="sticky-col p-8 font-bold text-base text-slate-800">
                                                    <div className="flex items-center justify-between"><div className="flex flex-col gap-1"><div className="flex items-center gap-2"><span>{h.icon}</span><span className="truncate max-w-[120px]">{h.name}</span></div><div className="flex items-center gap-2"><span className="text-[9px] font-black text-slate-400 uppercase tracking-widest bg-slate-100 px-2 py-0.5 rounded">{formatTimeRange(h.start, h.end)}</span>{isUrgent && <span className="w-1.5 h-1.5 rounded-full bg-red-400 animate-ping" />}</div></div><div className="flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity"><button onClick={() => { setNewHabit({ name: h.name, icon: h.icon, category: h.category, prompt: h.prompt || '', start: h.start, end: h.end }); setEditingHabitId(h.id); setIsAdding(true); }} className="p-2 text-slate-300 hover:text-indigo-600 transition-all"><Icons.Edit size={14} /></button><button onClick={() => deleteHabit(h.id)} className="p-2 text-slate-300 hover:text-red-500 transition-all"><Icons.Trash size={14} /></button></div></div>
                                                </td>
                                                {Array.from({length:31}, (_,i)=>i+1).map(day => {
                                                    const key = `${viewDate.getFullYear()}-${String(viewDate.getMonth()+1).padStart(2,'0')}-${String(day).padStart(2,'0')}-${h.id}`;
                                                    const isDone = completions[key]; 
                                                    const isT = day === adjustedTime.getUTCDate() && viewDate.getMonth() === adjustedTime.getUTCMonth(); 
                                                    
                                                    // Expiration logic:
                                                    // If today: expired if current hour >= end hour
                                                    // If past: always expired (unless done)
                                                    let isExpired = false;
                                                    if (isT) {
                                                        isExpired = currentHour >= h.end;
                                                    } else {
                                                        // Check if day is in past relative to adjustedTime
                                                        const cellDate = new Date(viewDate.getFullYear(), viewDate.getMonth(), day);
                                                        const todayDate = new Date(adjustedTime.getFullYear(), adjustedTime.getMonth(), adjustedTime.getUTCDate());
                                                        if (cellDate < todayDate) isExpired = true;
                                                    }

                                                    return (
                                                        <td key={day} className={`p-2 text-center transition-all ${isT ? 'bg-indigo-50/10' : ''}`}>
                                                            <button onClick={() => toggleHabit(day, h)} className={`check-anim w-12 h-12 rounded-2xl flex items-center justify-center mx-auto transition-all ${isDone ? 'bg-indigo-600 text-white shadow-lg' : isExpired ? 'bg-slate-100 text-slate-300' : 'bg-slate-50 text-slate-200 hover:bg-slate-100'} ${isT && !isDone && isUrgent ? 'border-2 border-red-400 urgent-pulse' : ''}`}>{isDone ? <Icons.Check size={16} /> : isExpired ? '‚úï' : '‚Ä¢'}</button>
                                                        </td>
                                                    );
                                                })}
                                            </tr>
                                        );
                                    })}
                                </tbody>
                            </table>
                        </div>
                    </div>

                    {/* PINBOARD SECTION */}
                    <div className="pt-10 space-y-8 text-center">
                        <div className="flex flex-col items-center gap-1">
                            <div className="flex items-center gap-4">
                                <h2 className="text-3xl font-black text-slate-900 tracking-tighter">Pinboard of Resolve</h2>
                                <button onClick={() => { setNoteType('reminder'); setIsJournalOpen(true); }} className="w-8 h-8 rounded-full border border-dashed border-slate-300 text-slate-400 hover:text-red-500 hover:border-red-200 flex items-center justify-center transition-all bg-white shadow-sm" title="Add Reminder"><Icons.Plus size={14} /></button>
                            </div>
                            <p className="text-[10px] font-black text-slate-400 uppercase tracking-[0.2em]">Identity anchors & system reminders</p>
                        </div>
                        <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-10 px-4 pb-20">
                            {quotes.map((q, i) => (
                                <div key={`quote-${i}`} className="dashboard-sticky p-10 min-h-[220px] relative transform rotate-[-2deg] flex items-center justify-center text-center group"><div className="sticky-pin" /><button onClick={() => { const nq = quotes.filter((_, idx) => idx !== i); setQuotes(nq); save(habits, completions, systemState, activityLogs, journalEntries, conversations, nq, reminders, quickLinks, todos); }} className="absolute top-4 right-4 text-red-300 opacity-0 group-hover:opacity-100 hover:text-red-600 transition-all"><Icons.Trash size={14} /></button><p className="text-2xl font-bold text-slate-700 italic leading-tight">"{q}"</p></div>
                            ))}
                            {reminders.map((r, i) => (
                                <div key={`rem-${i}`} className="dashboard-sticky dashboard-sticky-reminder p-10 min-h-[220px] relative transform rotate-[-1deg] group flex flex-col justify-center text-center"><div className="sticky-pin" /><button onClick={() => { const ur = reminders.filter(rm => rm.timestamp !== r.timestamp); setReminders(ur); save(habits, completions, systemState, activityLogs, journalEntries, conversations, quotes, ur, quickLinks, todos); }} className="absolute top-4 right-4 text-red-300 opacity-0 group-hover:opacity-100 hover:text-red-600 transition-all"><Icons.Trash size={14} /></button><span className="text-[10px] font-black text-red-500 uppercase tracking-[0.2em] mb-4">Identity Reminder</span><p className="text-xl font-bold text-red-900 leading-tight">"{r.text}"</p></div>
                            ))}
                        </div>
                    </div>

                    {/* MODALS SECTION */}
                    <React.Fragment>
                        {isPromptModalOpen && (
                            <div className="fixed inset-0 z-[140] bg-slate-900/60 backdrop-blur-xl flex items-center justify-center p-4 animate-fade-in">
                                <div className="bg-white w-full max-w-lg rounded-[3rem] p-10 shadow-2xl border border-white space-y-6 flex flex-col text-center">
                                    <div className="text-5xl mb-2">{activePromptHabit?.icon}</div>
                                    <h2 className="text-2xl font-black text-slate-900 tracking-tight">{activePromptHabit?.name} Complete</h2>
                                    <p className="text-indigo-600 font-bold italic text-lg leading-relaxed">"{activePromptHabit?.prompt}"</p>
                                    <textarea autoFocus value={promptInput} onChange={e => setPromptInput(e.target.value)} className="w-full h-32 p-6 bg-slate-50 rounded-[2rem] outline-none border focus:ring-4 ring-indigo-50 text-slate-800 shadow-inner" placeholder="Your answer..." />
                                    <div className="flex gap-4">
                                        <button onClick={() => setIsPromptModalOpen(false)} className="flex-1 py-4 font-black text-slate-400 uppercase text-xs tracking-widest">Skip</button>
                                        <button onClick={finalizePromptCompletion} className="flex-[2] bg-indigo-600 text-white py-5 rounded-[2rem] font-black shadow-xl hover:bg-indigo-700 transition-all uppercase text-xs tracking-widest">Log Insight</button>
                                    </div>
                                </div>
                            </div>
                        )}

                        {isJournalOpen && (
                            <div className="fixed inset-0 z-[120] bg-slate-900/60 backdrop-blur-xl flex items-center justify-center p-4 animate-fade-in">
                                <div className={`w-full max-w-2xl rounded-[3rem] p-12 shadow-2xl space-y-6 flex flex-col transition-colors duration-500 ${noteType === 'reflection' ? 'bg-white' : 'bg-[#fce4ec]'}`}>
                                    <div className="flex justify-center gap-4 mb-4">
                                        <button onClick={() => setNoteType('reflection')} className={`px-6 py-2 rounded-full text-[10px] font-black uppercase tracking-widest transition-all ${noteType === 'reflection' ? 'bg-slate-900 text-white' : 'bg-black/5 text-black/40'}`}>Reflection</button>
                                        <button onClick={() => setNoteType('reminder')} className={`px-6 py-2 rounded-full text-[10px] font-black uppercase tracking-widest transition-all ${noteType === 'reminder' ? 'bg-red-600 text-white' : 'bg-black/5 text-black/40'}`}>Reminder</button>
                                    </div>
                                    <h2 className="text-4xl font-black tracking-tighter text-center">{noteType === 'reflection' ? 'Capture Reflection' : 'Identity Reminder'}</h2>
                                    <textarea value={journalInput} onChange={e => setJournalInput(e.target.value)} className={`w-full h-64 p-8 rounded-[2rem] outline-none border-none leading-relaxed font-['Kalam'] text-xl shadow-inner resize-none ${noteType === 'reflection' ? 'bg-[#fff9c4] text-slate-800' : 'bg-[#fce4ec] text-red-900'}`} placeholder={noteType === 'reflection' ? "What's your raw truth today?" : "What must be remembered?"} />
                                    <div className="flex gap-4">
                                        <button onClick={() => { setIsJournalOpen(false); setJournalInput(""); }} className="flex-1 py-4 font-black text-slate-500 uppercase text-xs hover:bg-white/20 rounded-2xl transition-colors">Discard</button>
                                        <button onClick={() => { 
                                            if (noteType === 'reflection') {
                                                const u = [{ timestamp: new Date().toISOString(), text: journalInput }, ...journalEntries]; setJournalEntries(u); setIsJournalOpen(false); setJournalInput("");
                                                save(habits, completions, systemState, logActivity('reflection', 'Sealed'), u, conversations, quotes, reminders, quickLinks, todos);
                                            } else {
                                                const u = [{ timestamp: new Date().toISOString(), text: journalInput }, ...reminders]; setReminders(u); setIsJournalOpen(false); setJournalInput("");
                                                save(habits, completions, systemState, logActivity('reminder', 'Pinned'), journalEntries, conversations, quotes, u, quickLinks, todos);
                                            }
                                        }} className={`flex-[2] py-5 rounded-[2rem] font-black shadow-xl uppercase text-xs hover:scale-105 transition-all text-white ${noteType === 'reflection' ? 'bg-indigo-600' : 'bg-red-500'}`}>{noteType === 'reflection' ? 'Save to Ledger' : 'Pin to Board'}</button>
                                    </div>
                                </div>
                            </div>
                        )}

                        {isLinkModalOpen && (
                            <div className="fixed inset-0 z-[140] bg-slate-900/60 backdrop-blur-md flex items-center justify-center p-4 animate-fade-in">
                                <div className="bg-white w-full max-w-md rounded-[3rem] p-10 shadow-2xl border border-white space-y-6 flex flex-col">
                                    <h2 className="text-2xl font-black text-center text-slate-900">Add Quick Link</h2>
                                    <div className="space-y-4">
                                        <input type="text" value={newLink.icon} onChange={e => setNewLink({...newLink, icon: e.target.value})} placeholder="Icon (e.g., üìÖ)" className="w-full p-4 bg-slate-50 rounded-2xl outline-none text-center text-2xl" />
                                        <input type="text" value={newLink.title} onChange={e => setNewLink({...newLink, title: e.target.value})} placeholder="Title (e.g., Calendar)" className="w-full p-4 bg-slate-50 rounded-2xl outline-none font-bold" />
                                        <input type="text" value={newLink.url} onChange={e => setNewLink({...newLink, url: e.target.value})} placeholder="URL (https://...)" className="w-full p-4 bg-slate-50 rounded-2xl outline-none font-mono text-sm" />
                                    </div>
                                    <div className="flex gap-4">
                                        <button onClick={() => setIsLinkModalOpen(false)} className="flex-1 py-4 font-black text-slate-400 uppercase text-xs">Cancel</button>
                                        <button onClick={addQuickLink} className="flex-[2] bg-indigo-600 text-white py-4 rounded-2xl font-black shadow-lg uppercase text-xs">Add Link</button>
                                    </div>
                                </div>
                            </div>
                        )}

                        {isTaskModalOpen && (
                            <div className="fixed inset-0 z-[140] bg-slate-900/60 backdrop-blur-xl flex items-center justify-center p-4 animate-fade-in">
                                <div className="bg-white w-full max-w-3xl rounded-[4rem] p-10 shadow-2xl relative flex flex-col max-h-[85vh]">
                                    <div className="flex justify-between items-center mb-6">
                                        <h2 className="text-3xl font-black tracking-tighter">Task Protocol</h2>
                                        <button onClick={() => setIsTaskModalOpen(false)} className="text-slate-400 hover:text-slate-600 transition-colors">‚úï</button>
                                    </div>
                                    
                                    <div className="flex gap-2 mb-6">
                                        <input 
                                            type="text" 
                                            value={newTask} 
                                            onChange={e => setNewTask(e.target.value)}
                                            onKeyPress={e => e.key === 'Enter' && addTask()}
                                            placeholder="What needs to be done?" 
                                            className="flex-1 p-4 bg-slate-50 border border-slate-200 rounded-2xl outline-none focus:border-indigo-400 transition-colors"
                                        />
                                        <button onClick={addTask} className="bg-indigo-600 text-white px-6 rounded-2xl font-black hover:bg-indigo-700 transition-all"><Icons.Plus size={20} /></button>
                                    </div>

                                    <div className="flex-1 overflow-y-auto custom-scrollbar space-y-3 pr-2">
                                        {todos.filter(t => !t.done).length === 0 && todos.length > 0 && <div className="text-center text-slate-400 text-sm py-8">All tasks clear. Great work.</div>}
                                        {todos.length === 0 && <div className="text-center text-slate-300 italic py-10">No tasks defined.</div>}
                                        
                                        {todos.map(task => (
                                            <div key={task.id} className={`flex items-center gap-4 p-4 rounded-2xl border transition-all ${task.done ? 'bg-slate-50 border-transparent opacity-60' : 'bg-white border-slate-100 hover:border-indigo-100'}`}>
                                                <button onClick={() => toggleTask(task.id)} className={`w-6 h-6 rounded-lg border-2 flex items-center justify-center transition-all ${task.done ? 'bg-emerald-500 border-emerald-500 text-white' : 'border-slate-300 text-transparent hover:border-indigo-400'}`}>
                                                    <Icons.Check size={14} />
                                                </button>
                                                <span className={`flex-1 font-medium ${task.done ? 'line-through text-slate-400' : 'text-slate-800'}`}>{task.text}</span>
                                                <button onClick={() => deleteTask(task.id)} className="text-slate-300 hover:text-red-500 transition-colors"><Icons.Trash size={16} /></button>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            </div>
                        )}

                        {isAiOpen && (
                            <div className="fixed inset-0 z-[110] bg-slate-900/90 backdrop-blur-xl flex items-center justify-center p-4">
                                <div className="bg-white w-full max-w-6xl rounded-[4rem] shadow-2xl h-[85vh] flex overflow-hidden border border-white/20">
                                    <div className={`${isSidebarOpen ? 'translate-x-0' : '-translate-x-full'} md:translate-x-0 transition-transform duration-300 fixed md:relative z-50 md:z-auto w-72 h-full bg-slate-50 border-r flex flex-col`}>
                                        <div className="p-8 border-b flex items-center"><button onClick={createNewChat} className="w-full py-4 bg-indigo-600 text-white rounded-2xl font-black text-[11px] uppercase tracking-widest shadow-lg hover:bg-indigo-700 transition-all">New Session +</button></div>
                                        <div className="flex-1 overflow-y-auto p-4 space-y-3 custom-scrollbar">
                                            {conversations.map(c => (
                                                <div key={c.id} className={`p-5 rounded-[2rem] cursor-pointer transition-all ${activeChatId === c.id ? 'bg-white shadow-soft border border-indigo-100' : 'hover:bg-white/50'}`} onClick={() => { setActiveChatId(c.id); setIsSidebarOpen(false); }}>
                                                    <div className="text-[9px] font-black text-slate-400 uppercase mb-1 text-center">Session</div>
                                                    <div className="text-xs font-bold truncate text-slate-700">{c.title}</div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                    <div className="flex-1 flex flex-col bg-white relative">
                                        <div className="p-8 border-b flex justify-between items-center bg-indigo-600 text-white shrink-0">
                                            <div className="flex items-center gap-4"><button onClick={() => setIsSidebarOpen(true)} className="md:hidden bg-white/20 p-2 rounded-xl">‚â°</button><h2 className="text-2xl font-black tracking-tight">{activeChat?.title || "Adviser Session"}</h2></div>
                                            <button onClick={() => setIsAiOpen(false)} className="bg-white/20 p-3 rounded-full hover:bg-white/30 transition-all">‚úï</button>
                                        </div>
                                        <div className="flex-1 overflow-y-auto p-6 md:p-10 space-y-6 custom-scrollbar bg-slate-50/30">
                                            {activeChat?.messages.map((m, i) => <AiMessage key={i} text={m.text} role={m.role} />)}
                                            {isAiLoading && <div className="text-[10px] font-black text-indigo-400 animate-pulse text-center uppercase tracking-widest">Architect is reasoning...</div>}
                                        </div>
                                        <div className="p-6 md:p-8 border-t flex gap-4 bg-white shrink-0"><input value={aiInput} onChange={e => setAiInput(e.target.value)} onKeyPress={e => e.key === 'Enter' && handleAiSend()} className="flex-1 bg-slate-50 p-5 rounded-3xl text-sm outline-none border focus:border-indigo-200 shadow-inner" placeholder="Ask the Architect..." /><button onClick={handleAiSend} className="bg-slate-900 text-white px-8 rounded-3xl font-black">‚Üí</button></div>
                                    </div>
                                </div>
                            </div>
                        )}

                        {isAdding && (
                            <div className="fixed inset-0 z-[130] flex items-center justify-center p-4 bg-slate-900/60 backdrop-blur-md animate-fade-in">
                                <div className="bg-white w-full max-w-lg rounded-[3rem] p-10 md:p-12 shadow-2xl border border-white space-y-8">
                                    <h2 className="text-3xl font-black tracking-tighter text-slate-900 text-center">{editingHabitId ? 'Update Architecture' : 'Establish Ritual'}</h2>
                                    <div className="space-y-6">
                                        <div className="flex gap-4">
                                            <input type="text" value={newHabit.icon} onChange={(e) => setNewHabit({...newHabit, icon: e.target.value})} className="w-20 p-5 bg-slate-50 border border-slate-100 rounded-3xl text-3xl text-center outline-none" placeholder="‚ú®" />
                                            <input type="text" value={newHabit.name} onChange={(e) => setNewHabit({...newHabit, name: e.target.value})} className="flex-1 p-5 bg-slate-50 border border-slate-100 rounded-3xl font-bold text-lg outline-none text-slate-800" placeholder="Ritual Name..." />
                                        </div>
                                        <div className="space-y-3">
                                            <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest text-center block">Completion Prompt (Optional)</label>
                                            <input type="text" value={newHabit.prompt} onChange={(e) => setNewHabit({...newHabit, prompt: e.target.value})} className="w-full p-4 bg-slate-50 border border-slate-100 rounded-2xl text-sm italic outline-none text-slate-700 shadow-inner" placeholder="e.g., What did you learn?" />
                                        </div>
                                        <div className="space-y-3">
                                            <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest text-center block">Active Window (Hours)</label>
                                            <div className="flex gap-3">
                                                <div className="flex-1">
                                                    <span className="text-[9px] font-bold text-slate-400 ml-2">Start (0-23)</span>
                                                    <input type="number" min="0" max="23" value={newHabit.start !== undefined ? newHabit.start : 0} onChange={(e) => setNewHabit({...newHabit, start: parseInt(e.target.value)})} className="w-full p-4 bg-slate-50 border border-slate-100 rounded-2xl text-center outline-none" />
                                                </div>
                                                <div className="flex-1">
                                                    <span className="text-[9px] font-bold text-slate-400 ml-2">End (1-24)</span>
                                                    <input type="number" min="1" max="24" value={newHabit.end !== undefined ? newHabit.end : 24} onChange={(e) => setNewHabit({...newHabit, end: parseInt(e.target.value)})} className="w-full p-4 bg-slate-50 border border-slate-100 rounded-2xl text-center outline-none" />
                                                </div>
                                            </div>
                                        </div>
                                        <div className="flex gap-4 pt-4">
                                            <button onClick={() => { setIsAdding(false); setEditingHabitId(null); }} className="flex-1 py-4 font-black text-slate-400 uppercase text-xs tracking-widest">Discard</button>
                                            <button onClick={handleRitualSubmit} className="flex-[2] bg-indigo-600 text-white py-4 rounded-[2rem] font-black shadow-xl hover:bg-indigo-700 transition-all uppercase text-xs tracking-widest hover:scale-105">{editingHabitId ? 'Update' : 'Establish'}</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}

                        {isInfoOpen && (
                            <div className="fixed inset-0 z-[120] bg-slate-900/90 backdrop-blur-lg flex items-center justify-center p-6">
                                <div className="bg-white w-full max-w-xl rounded-[4rem] p-12 shadow-2xl space-y-8 animate-fade-in flex flex-col max-h-[90vh]">
                                    <h2 className="text-4xl font-black">Configuration</h2>
                                    <div className="space-y-6 overflow-y-auto pr-2 custom-scrollbar">
                                        <div className="p-8 bg-slate-50 rounded-[2.5rem] space-y-4 text-center">
                                            <h4 className="text-[10px] font-black text-indigo-600 uppercase tracking-widest">Pinboard Anchors</h4>
                                            <div className="flex gap-2">
                                                <input type="text" value={newQuoteInput} onChange={(e) => setNewQuoteInput(e.target.value)} placeholder="Add anchor..." className="flex-1 p-3 bg-white border rounded-xl text-xs outline-none shadow-inner" onKeyPress={e => e.key === 'Enter' && (setQuotes([...quotes, newQuoteInput]), setNewQuoteInput(''))} />
                                                <button onClick={() => { if(!newQuoteInput) return; setQuotes([...quotes, newQuoteInput]); setNewQuoteInput(''); }} className="bg-indigo-600 text-white px-4 rounded-xl font-bold shadow-lg">+</button>
                                            </div>
                                            <div className="space-y-2 max-h-32 overflow-y-auto">
                                                {quotes.map((q, i) => (
                                                    <div key={i} className="flex justify-between items-center text-[11px] p-2 bg-white rounded-lg border">
                                                        <span className="truncate italic text-slate-600 font-['Kalam']">"{q}"</span>
                                                        <button onClick={() => setQuotes(quotes.filter((_, idx) => idx !== i))} className="text-red-400 ml-2 hover:scale-110 transition-all">‚úï</button>
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                        <div className="p-8 bg-slate-50 rounded-[2.5rem] space-y-4 text-center">
                                            <h4 className="text-[10px] font-black text-indigo-600 uppercase tracking-widest">Intelligence Setup</h4>
                                            <input type="password" value={systemState.geminiKey} onChange={e => setSystemState({...systemState, geminiKey: e.target.value.trim()})} placeholder="Paste Gemini Key" className="w-full p-4 bg-white border rounded-2xl text-xs outline-none focus:ring-4 ring-indigo-100 shadow-sm" />
                                            <textarea value={systemState.geminiPersona} onChange={e => setSystemState({...systemState, geminiPersona: e.target.value})} className="w-full p-4 h-32 bg-white border rounded-2xl text-xs outline-none focus:ring-4 ring-indigo-100 shadow-sm" />
                                        </div>
                                        <div className="p-8 bg-slate-50 rounded-[2.5rem] text-center">
                                            <h4 className="text-[10px] font-black text-indigo-600 uppercase mb-4 tracking-widest">GMT Offset</h4>
                                            <select value={systemState.gmtOffset} onChange={e => setSystemState({...systemState, gmtOffset: parseInt(e.target.value)})} className="p-3 w-full rounded-2xl font-bold bg-white border outline-none text-sm text-center shadow-sm">{Array.from({length:27}, (_,i)=>i-12).map(o => <option key={o} value={o}>GMT {o>=0?'+':''}{o}</option>)}</select>
                                        </div>
                                    </div>
                                    <button onClick={() => { setIsInfoOpen(false); save(habits, completions, systemState, activityLogs, journalEntries, conversations, quotes, reminders, quickLinks, todos); }} className="w-full py-5 bg-slate-900 text-white rounded-[2rem] font-black text-xs uppercase tracking-widest shadow-xl active:scale-95 transition-all">Save & Close</button>
                                </div>
                            </div>
                        )}

                        {/* LEDGER MODAL */}
                        {isLogOpen && (
                            <div className="fixed inset-0 z-[120] bg-slate-900/90 backdrop-blur-lg flex items-center justify-center p-4 md:p-6">
                                <div className="bg-white w-full max-w-4xl rounded-[4rem] p-10 shadow-2xl relative flex flex-col max-h-[85vh]">
                                    <button onClick={() => setIsLogOpen(false)} className="absolute top-8 right-10 text-slate-400 text-2xl hover:text-slate-600">‚úï</button>
                                    <h2 className="text-4xl font-black tracking-tighter mb-6 text-center text-slate-900">Intelligence Ledger</h2>
                                    <div className="flex bg-slate-100 p-1.5 rounded-[2rem] mb-8 shrink-0">
                                        {['journal', 'reminders', 'integrity', 'activity'].map(t => <button key={t} onClick={() => setLogTab(t)} className={`flex-1 py-3 text-[10px] font-black uppercase rounded-[1.5rem] transition-all ${logTab === t ? 'bg-white shadow-md text-indigo-600' : 'text-slate-400'}`}>{t}</button>)}
                                    </div>
                                    <div className="flex-1 overflow-y-auto custom-scrollbar space-y-8 p-4">
                                        {logTab === 'integrity' && integrityMetrics.logs.map((l, i) => (
                                            <div key={i} className="p-6 bg-slate-50 rounded-[2.5rem] border flex flex-col gap-4 shadow-sm"><div className="flex justify-between items-center"><div className="space-y-1"><div className="text-[9px] font-black text-slate-400 uppercase tracking-widest">{l.date} ‚Ä¢ {l.time}</div><div className="text-sm font-bold text-slate-800">{l.reason}</div></div><div className={`text-sm font-black px-4 py-2 rounded-2xl ${l.type==='plus'?'text-emerald-600 bg-emerald-50':'text-orange-600 bg-orange-50'}`}>{l.points}</div></div>{l.answer && <div className="bg-indigo-50/50 p-4 rounded-2xl italic text-xs text-indigo-900">‚Äú{l.answer}‚Äù</div>}</div>
                                        ))}
                                        {logTab === 'activity' && activityLogs.map((log, i) => <div key={i} className="p-5 bg-slate-50 rounded-[2rem] border text-[11px] font-bold text-slate-800 shadow-sm">{log.humanReadable}</div>)}
                                        {logTab === 'journal' && (
                                            <div className="space-y-8 pl-4 border-l-2 border-slate-100">
                                                {journalEntries.map((e, i) => (
                                                    <div key={i} className="relative pl-6">
                                                        <div className="absolute -left-[21px] top-0 w-3 h-3 rounded-full bg-slate-200 border-2 border-white ring-2 ring-indigo-50" />
                                                        <div className="flex justify-between items-start mb-2">
                                                            <span className="text-[10px] font-black text-indigo-400 uppercase tracking-widest">{new Date(e.timestamp).toLocaleString()}</span>
                                                            <button onClick={() => { if(confirm("Permanently erase this record?")) { const u = journalEntries.filter(je => je.timestamp !== e.timestamp); setJournalEntries(u); save(habits, completions, systemState, activityLogs, u, conversations, quotes, reminders, quickLinks, todos); } }} className="text-slate-300 hover:text-red-500 transition-colors"><Icons.Trash size={14} /></button>
                                                        </div>
                                                        <p className="text-sm text-slate-700 leading-relaxed font-sans border-l-2 border-indigo-100 pl-4 py-1">{e.text}</p>
                                                    </div>
                                                ))}
                                                {journalEntries.length === 0 && <div className="text-center py-20 text-slate-300 font-medium italic">Timeline clear. Begin your observation log.</div>}
                                            </div>
                                        )}
                                        {logTab === 'reminders' && (<div className="grid grid-cols-1 md:grid-cols-2 gap-6">{reminders.map((r, i) => (<div key={i} className={`dashboard-sticky dashboard-sticky-reminder p-8 rounded-sm transform ${i % 2 === 0 ? 'rotate-1' : '-rotate-1'} group`}><div className="sticky-pin" /><div className="flex justify-between items-start mb-4"><span className="text-[9px] font-black text-red-400 uppercase tracking-widest">Active Reminder</span><button onClick={() => { const ur = reminders.filter(rm => rm.timestamp !== r.timestamp); setReminders(ur); save(habits, completions, systemState, activityLogs, journalEntries, conversations, quotes, ur, quickLinks, todos); }} className="opacity-0 group-hover:opacity-100 text-red-300 hover:text-red-500 transition-all"><Icons.Trash size={14} /></button></div><p className="text-lg font-bold text-red-900 leading-tight">"{r.text}"</p></div>))}</div>)}
                                    </div>
                                </div>
                            </div>
                        )}
                    </React.Fragment>

                    {/* FAB COMMAND CENTER */}
                    <div className="fixed bottom-8 right-8 group fab-container z-[100]">
                        <div className="flex flex-col items-end gap-3 mb-4 pointer-events-none group-hover:pointer-events-auto">
                            <button onClick={() => { if(!conversations.length) createNewChat(); setIsAiOpen(true); }} className="fab-menu-item w-14 h-14 bg-indigo-600 text-white rounded-2xl shadow-xl flex items-center justify-center text-xl hover:bg-indigo-700 pointer-events-auto transition-all"><Icons.Brain size={18} /></button>
                            <button onClick={() => { setNoteType('reflection'); setIsJournalOpen(true); }} className="fab-menu-item w-14 h-14 bg-white border text-slate-700 rounded-2xl shadow-xl flex items-center justify-center text-xl hover:bg-slate-50 pointer-events-auto transition-all">üìù</button>
                            <button onClick={() => { setIsLogOpen(true); setLogTab('journal'); }} className="fab-menu-item w-14 h-14 bg-white border text-slate-700 rounded-2xl shadow-xl flex items-center justify-center text-xl hover:bg-slate-50 pointer-events-auto transition-all">üìã</button>
                            <button onClick={() => setIsInfoOpen(true)} className="fab-menu-item w-14 h-14 bg-white border text-slate-700 rounded-2xl shadow-xl flex items-center justify-center text-xl hover:bg-slate-50 pointer-events-auto transition-all">‚öôÔ∏è</button>
                        </div>
                        <button className="w-16 h-16 bg-slate-900 text-white rounded-full shadow-2xl flex items-center justify-center transition-transform duration-300 group-hover:rotate-45">
                            <Icons.Plus size={28} />
                        </button>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
